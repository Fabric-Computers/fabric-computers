local event = os.loadLibrary("event")
local keys = os.loadLibrary("keys")

local io = {}

io.screen = nil

for i=0, 5 do
    local component = computer:getComponent(i)
    if component then
        if component:getComponentType() == "screen" then
            io.screen = component
        end
    end
end

function io.setPixel(x, y, color)
    if io.screen then
        io.screen:setPixel(x, y, color)
    end
end

local charMap = {}

-- from on https://github.com/dhepper/font8x8/blob/master/font8x8_basic.h (Public Domain)
charMap[" "] = {w=8, h=8, b={0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}
charMap["!"] = {w=8, h=8, b={0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}}
charMap["\""] = {w=8, h=8, b={0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}
charMap["#"] = {w=8, h=8, b={0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00}}
charMap["$"] = {w=8, h=8, b={0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00}}
charMap["%"] = {w=8, h=8, b={0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00}}
charMap["&"] = {w=8, h=8, b={0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00}}
charMap["'"] = {w=8, h=8, b={0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00}}
charMap["("] = {w=8, h=8, b={0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00}}
charMap[")"] = {w=8, h=8, b={0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00}}
charMap["*"] = {w=8, h=8, b={0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}}
charMap["+"] = {w=8, h=8, b={0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00}}
charMap[","] = {w=8, h=8, b={0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x06}}
charMap["-"] = {w=8, h=8, b={0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00}}
charMap["."] = {w=8, h=8, b={0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}}
charMap["/"] = {w=8, h=8, b={0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00}}
charMap["0"] = {w=8, h=8, b={0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00}}
charMap["1"] = {w=8, h=8, b={0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00}}
charMap["2"] = {w=8, h=8, b={0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x3F, 0x00}}
charMap["3"] = {w=8, h=8, b={0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x1E, 0x00}}
charMap["4"] = {w=8, h=8, b={0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x78, 0x00}}
charMap["5"] = {w=8, h=8, b={0x3F, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E, 0x00}}
charMap["6"] = {w=8, h=8, b={0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x1E, 0x00}}
charMap["7"] = {w=8, h=8, b={0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x00}}
charMap["8"] = {w=8, h=8, b={0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x1E, 0x00}}
charMap["9"] = {w=8, h=8, b={0x1E, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E, 0x00}}
charMap[":"] = {w=8, h=8, b={0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00}}
charMap[";"] = {w=8, h=8, b={0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x06}}
charMap["<"] = {w=8, h=8, b={0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00}}
charMap["="] = {w=8, h=8, b={0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00}}
charMap[">"] = {w=8, h=8, b={0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00}}
charMap["?"] = {w=8, h=8, b={0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00}}
charMap["@"] = {w=8, h=8, b={0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00}}
charMap["A"] = {w=8, h=8, b={0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00}}
charMap["B"] = {w=8, h=8, b={0x3F, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3F, 0x00}}
charMap["C"] = {w=8, h=8, b={0x3C, 0x66, 0x03, 0x03, 0x03, 0x66, 0x3C, 0x00}}
charMap["D"] = {w=8, h=8, b={0x1F, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1F, 0x00}}
charMap["E"] = {w=8, h=8, b={0x7F, 0x46, 0x16, 0x1E, 0x16, 0x46, 0x7F, 0x00}}
charMap["F"] = {w=8, h=8, b={0x7F, 0x46, 0x16, 0x1E, 0x16, 0x06, 0x0F, 0x00}}
charMap["G"] = {w=8, h=8, b={0x3C, 0x66, 0x03, 0x03, 0x73, 0x66, 0x7C, 0x00}}
charMap["H"] = {w=8, h=8, b={0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00}}
charMap["I"] = {w=8, h=8, b={0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}}
charMap["J"] = {w=8, h=8, b={0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00}}
charMap["K"] = {w=8, h=8, b={0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00}}
charMap["L"] = {w=8, h=8, b={0x0F, 0x06, 0x06, 0x06, 0x46, 0x66, 0x7F, 0x00}}
charMap["M"] = {w=8, h=8, b={0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00}}
charMap["N"] = {w=8, h=8, b={0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00}}
charMap["O"] = {w=8, h=8, b={0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00}}
charMap["P"] = {w=8, h=8, b={0x3F, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00}}
charMap["Q"] = {w=8, h=8, b={0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00}}
charMap["R"] = {w=8, h=8, b={0x3F, 0x66, 0x66, 0x3E, 0x36, 0x66, 0x67, 0x00}}
charMap["S"] = {w=8, h=8, b={0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00}}
charMap["T"] = {w=8, h=8, b={0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}}
charMap["U"] = {w=8, h=8, b={0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00}}
charMap["V"] = {w=8, h=8, b={0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}}
charMap["W"] = {w=8, h=8, b={0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00}}
charMap["X"] = {w=8, h=8, b={0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00}}
charMap["Y"] = {w=8, h=8, b={0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00}}
charMap["Z"] = {w=8, h=8, b={0x7F, 0x63, 0x31, 0x18, 0x4C, 0x66, 0x7F, 0x00}}
charMap["["] = {w=8, h=8, b={0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x1E, 0x00}}
charMap["\\"] = {w=8, h=8, b={0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00}}
charMap["]"] = {w=8, h=8, b={0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00}}
charMap["^"] = {w=8, h=8, b={0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00}}
charMap["_"] = {w=8, h=8, b={0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}}
charMap["`"] = {w=8, h=8, b={0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}}
charMap["a"] = {w=8, h=8, b={0x00, 0x00, 0x1E, 0x30, 0x3E, 0x33, 0x6E, 0x00}}
charMap["b"] = {w=8, h=8, b={0x07, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3B, 0x00}}
charMap["c"] = {w=8, h=8, b={0x00, 0x00, 0x1E, 0x33, 0x03, 0x33, 0x1E, 0x00}}
charMap["d"] = {w=8, h=8, b={0x38, 0x30, 0x30, 0x3e, 0x33, 0x33, 0x6E, 0x00}}
charMap["e"] = {w=8, h=8, b={0x00, 0x00, 0x1E, 0x33, 0x3f, 0x03, 0x1E, 0x00}}
charMap["f"] = {w=8, h=8, b={0x1C, 0x36, 0x06, 0x0f, 0x06, 0x06, 0x0F, 0x00}}
charMap["g"] = {w=8, h=8, b={0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x1F}}
charMap["h"] = {w=8, h=8, b={0x07, 0x06, 0x36, 0x6E, 0x66, 0x66, 0x67, 0x00}}
charMap["i"] = {w=8, h=8, b={0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}}
charMap["j"] = {w=8, h=8, b={0x30, 0x00, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E}}
charMap["k"] = {w=8, h=8, b={0x07, 0x06, 0x66, 0x36, 0x1E, 0x36, 0x67, 0x00}}
charMap["l"] = {w=8, h=8, b={0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}}
charMap["m"] = {w=8, h=8, b={0x00, 0x00, 0x33, 0x7F, 0x7F, 0x6B, 0x63, 0x00}}
charMap["n"] = {w=8, h=8, b={0x00, 0x00, 0x1F, 0x33, 0x33, 0x33, 0x33, 0x00}}
charMap["o"] = {w=8, h=8, b={0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00}}
charMap["p"] = {w=8, h=8, b={0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x0F}}
charMap["q"] = {w=8, h=8, b={0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x78}}
charMap["r"] = {w=8, h=8, b={0x00, 0x00, 0x3B, 0x6E, 0x66, 0x06, 0x0F, 0x00}}
charMap["s"] = {w=8, h=8, b={0x00, 0x00, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x00}}
charMap["t"] = {w=8, h=8, b={0x08, 0x0C, 0x3E, 0x0C, 0x0C, 0x2C, 0x18, 0x00}}
charMap["u"] = {w=8, h=8, b={0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x6E, 0x00}}
charMap["v"] = {w=8, h=8, b={0x00, 0x00, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}}
charMap["w"] = {w=8, h=8, b={0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00}}
charMap["x"] = {w=8, h=8, b={0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00}}
charMap["y"] = {w=8, h=8, b={0x00, 0x00, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x1F}}
charMap["z"] = {w=8, h=8, b={0x00, 0x00, 0x3F, 0x19, 0x0C, 0x26, 0x3F, 0x00}}
charMap["{"] = {w=8, h=8, b={0x38, 0x0C, 0x0C, 0x07, 0x0C, 0x0C, 0x38, 0x00}}
charMap["|"] = {w=8, h=8, b={0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00}}
charMap["}"] = {w=8, h=8, b={0x07, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0x07, 0x00}}
charMap["~"] = {w=8, h=8, b={0x6E, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}

function io.putChar(character, xPos, yPos, foreground, background)
    if charMap[character] and io.screen then
        local glyph = charMap[character]

        for y=0, glyph["h"]-1 do
            for x=0, glyph["w"]-1 do
                if computer:crazyBitHack(glyph["b"][y+1], x) then
                    io.screen:setPixel(xPos + x, yPos + y, foreground)
                else
                    io.screen:setPixel(xPos + x, yPos + y, background)
                end
            end
        end
    end
end

if not _G.currentLine then
    _G.currentLine = 0
    _G.currentColumn = 0
end
io.currentForeground = 0xFFFFFF
io.currentBackground = 0x000000

function io.writeString(s, x, y, foreground, background)
    local cur = 0
    local prevWidth = 0
    for i=0, #s do
        if s:sub(i, i) then
            if charMap[s:sub(i, i)] then
                io.putChar(s:sub(i, i), x + cur, y, foreground, background)
                prevWidth = charMap[s:sub(i, i)]["w"]
                cur = cur + prevWidth + 1
            end
        end
    end
end

function io.print(s)
    if not s then
        s = "NIL"
    end

    s = s:upper()

    local maxHeight = 0
    for i=0, #s do
        if charMap[s:sub(i, i)] then
            if charMap[s:sub(i, i)]["h"] > maxHeight then
                maxHeight = charMap[s:sub(i, i)]["h"]
            end
        end
    end

    io.writeString(s, _G.currentColumn, _G.currentLine, io.currentForeground, io.currentBackground)

    _G.currentLine = _G.currentLine + maxHeight + 1
end

function io.writeFile(path, content)
    fs:writeFile(path, content)
end

function io.readFile(path)
    return fs:readFile(path)
end

function io.makeDir(path)
    fs:makeDir(path)
end

function io.write(s)
    local maxHeight = 0
    local length = 0
    local prevWidth = 0
    for i=0, #s do
        if charMap[s:sub(i, i)] then
            prevWidth = charMap[s:sub(i, i)]["w"]
            length = length + prevWidth + 1
            if charMap[s:sub(i, i)]["h"] > maxHeight then
                maxHeight = charMap[s:sub(i, i)]["h"]
            end
        end
    end

    io.writeString(s, _G.currentColumn, _G.currentLine, io.currentForeground, io.currentBackground)

    _G.currentColumn = _G.currentColumn + length
end

function io.clear(color)
    if screen then
        local size = screen:getScreenSize()
        for x=0, size[1] do
            for y=0, size[2] do
                io.setPixel(x, y, color)
            end
        end
    end
end

function io.getStringSize(s)
    s = s:upper()

    local maxHeight = 0
    local width = 0

    for i=0, #s do
        local c = s:sub(i, i)
        if charMap[c] then
            if charMap[c]["h"] > maxHeight then
                maxHeight = charMap[c]["h"]
            end

            width = width + charMap[c]["w"] + 1
        end
    end

    return width, maxHeight
end

function io.readLine()
    local x = _G.currentColumn
    local y = _G.currentLine
    local result = ""
    while true do
        eventName, key = event.pollEvents()
        if eventName == "key_down" then
            if key >= keys.A and key <= keys.Z then
                result = result .. string.char(key)
                io.setCursor(x, y)
                io.print(result)
            elseif key == keys.SPACE then
                result = result .. " "
                io.setCursor(x, y)
                io.print(result)
            elseif key == keys.BACKSPACE then
                local width, height = io.getStringSize(result)
                print(width)
                for xPos=0, width do
                    for yPos=0, height do
                        io.setPixel(x+xPos, y+yPos, io.backgroundColor)
                    end
                end

                result = result:sub(1, -2)
                io.setCursor(x, y)
                io.print(result)
            elseif key == keys.ENTER then
                return result
            end
        end
    end
end

function io.exists(path)
    return _G.fileSystem:exists(path)
end

function io.error(message)
    local foregroundColor = io.currentForeground
    local backgroundColor = io.backgroundColor
    io.setBackground(0x000000)
    io.setForeground(0xFFFFFF)
    io.print(message)
    io.setForeground(foregroundColor)
    io.setBackground(backgroundColor)
end

function io.setForeground(color)
    io.currentForeground = color
end

function io.setBackground(color)
    io.currentBackground = color
end

function io.setCursor(x, y)
    _G.currentLine = y
    _G.currentColumn = x
end

return io